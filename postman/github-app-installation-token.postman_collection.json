{
  "info": {
    "name": "GitHub App Installation Token",
    "description": "One-click exchange of a GitHub App JWT for an installation access token, plus a helper request to list repositories with that token.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Get installation access token",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const crypto = require('crypto');",
              "const appId = pm.environment.get('github_app_id');",
              "const installationId = pm.environment.get('github_installation_id');",
              "let privateKey = pm.environment.get('github_private_key');",
              "if (!appId) { throw new Error('Set github_app_id in your environment.'); }",
              "if (!installationId) { throw new Error('Set github_installation_id in your environment.'); }",
              "if (!privateKey) { throw new Error('Paste your GitHub App private key into github_private_key.'); }",
              "privateKey = privateKey.replace(/\\n/g, '\n');",
              "const now = Math.floor(Date.now() / 1000);",
              "const payload = {",
              "  iat: now - 60,",
              "  exp: now + 540,",
              "  iss: appId",
              "};",
              "const header = { alg: 'RS256', typ: 'JWT' };",
              "const base64Url = (input) => Buffer.from(typeof input === 'string' ? input : JSON.stringify(input))",
              "  .toString('base64')",
              "  .replace(/=/g, '')",
              "  .replace(/\\+/g, '-')",
              "  .replace(/\\//g, '_');",
              "const encodedHeader = base64Url(header);",
              "const encodedPayload = base64Url(payload);",
              "const unsignedToken = `${encodedHeader}.${encodedPayload}`;",
              "const signer = crypto.createSign('RSA-SHA256');",
              "signer.update(unsignedToken);",
              "const encodedSignature = signer",
              "  .sign(privateKey, 'base64')",
              "  .replace(/=/g, '')",
              "  .replace(/\\+/g, '-')",
              "  .replace(/\\//g, '_');",
              "const jwt = `${unsignedToken}.${encodedSignature}`;",
              "pm.environment.set('github_jwt', jwt);",
              "pm.request.headers.upsert({ key: 'Authorization', value: `Bearer ${jwt}` });"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Returned 201 Created', function () {",
              "  pm.response.to.have.status(201);",
              "});",
              "if (pm.response.code === 201) {",
              "  const body = pm.response.json();",
              "  pm.environment.set('github_installation_token', body.token);",
              "  pm.environment.set('github_installation_token_expires_at', body.expires_at);",
              "  console.log('Installation token expires at', body.expires_at);",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Accept",
            "name": "Accept",
            "value": "application/vnd.github+json",
            "type": "text"
          },
          {
            "key": "X-GitHub-Api-Version",
            "value": "2022-11-28",
            "type": "text"
          },
          {
            "key": "Content-Type",
            "value": "application/json",
            "type": "text"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{}"
        },
        "url": {
          "raw": "https://api.github.com/app/installations/{{github_installation_id}}/access_tokens",
          "protocol": "https",
          "host": [
            "api",
            "github",
            "com"
          ],
          "path": [
            "app",
            "installations",
            "{{github_installation_id}}",
            "access_tokens"
          ]
        }
      },
      "response": []
    },
    {
      "name": "List repositories with installation token",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const token = pm.environment.get('github_installation_token');",
              "if (!token) { throw new Error('Run \"Get installation access token\" first.'); }",
              "pm.request.headers.upsert({ key: 'Authorization', value: `Bearer ${token}` });"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Request succeeded', function () {",
              "  pm.response.to.have.status(200);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Accept",
            "value": "application/vnd.github+json"
          },
          {
            "key": "X-GitHub-Api-Version",
            "value": "2022-11-28"
          }
        ],
        "url": {
          "raw": "https://api.github.com/installation/repositories",
          "protocol": "https",
          "host": [
            "api",
            "github",
            "com"
          ],
          "path": [
            "installation",
            "repositories"
          ]
        }
      },
      "response": []
    }
  ]
}
